const descriptions = {
  '1-00-00': `「刚切中元节24h」「夢廻の町 00:00」\n\n——“Chase，别看地图了。”\n\n——“可是，刚、”\n\n——“好了！看镜头，照片是要给姐姐看的。”\n\n——“……等等，刚、”\n\n“咔嚓”`,
  '1-01-00': `「刚切中元节24h」「夢廻の町 01:00」\n\n我们在德国罗腾堡。Chase说，德国有两个罗腾堡，刚，我们要去哪个？当然是南边的那个，我头也不抬。\n\n南罗腾堡是德国巴伐利亚最出名的小镇。我说。有人会叫她中世纪明珠，是一座像童话一样美丽的小镇。\n\nChase说，像童话一样？\n\n我笑了，是呀，像童话一样。嗯，Chase，我们一起到了那里，你或许就明白了。\n\n现在我们在这里。\n\n说实话，我不是第一次来这里，这里足够美丽，我忍不住又一次举起相机。余光里，那个搞不懂的家伙不知什么时候蹲下去了，在看什么？\n\n我低头去看，一只鸽子，有什么好看的？`,
  '1-02-00': `「刚切中元节24h」「夢廻の町 02:00」\n\nAll that we see or seem\nIs but a dream within a dream.\nIs all that we see or seem\nBut a dream within a dream?\n\n——Edgar Allan Poe, A Dream Within a Dream(1849)`,
  '1-03-00': `「刚切中元节24h」「夢廻の町 03:00」\n\n“Naked came I out of my mother’s womb, and naked shall I return thither.”\n\n「我赤身从母胎而出，页必赤身归回。」\n\n——《圣经·约伯记》1:21`,
  '1-04-00': `「刚切中元节24h」「夢廻の町 04:00」\n\n偶尔、刚坐到仪器里，闭上眼睛试图做一个有用的梦的时候，会有这样的梦境降临。\n在某个可能存在，不过是否真的存在也并无意义的世界，或许他们两个不曾做过你死我活的战斗。或许可以远离战斗、和平和死亡，然后是欢喜还是冤家都不重要。\n没有意义也不重要，刚挣开眼睛的时候，只有在修普诺斯担忧的眼神里皱着眉扯出一个笑。\n“看来是用不上的数据。浪费了时间啊。”\n修普诺斯不赞同地说：“睡眠任何时候都不会是浪费。”`,
  '1-05-00':`「刚切中元节24h」「夢廻の町 05:00」\n\n故障的红光星星点点地闪烁着。\n实验室的灯似乎很少被打开，远离Chase的身躯的地方，一切笼罩在绿色的光线内。\n很久以前——久到诗岛刚还几乎无忧无虑的时候，蓄着白胡子的教授搂着他的肩膀，把他带到实验室里介绍着。那个时候他想什么来着？\n啊——为什么实验室都是这样的灯光呢？\n——我其实对实验室什么的没心情也大概没什么天赋啦！\n现在都是些模糊的话语。\n诗岛刚手里的记录板上写满了每天的实验数据，还有对错误的修正和导致其原因的推测。Chase——没有完整数据的Chase还是Chase吗？总之，那个顶着Chase面容和皮囊的物体在培养舱的荧蓝色灯光里。对所有的一切都毫无反应。\n诗岛刚连沮丧的叹气都嫌多余了。`,
  '1-06-00':`「刚切中元节24h」「夢廻の町 06:00」\n\n对于Roidmude来说，似乎衣服只是微不足道的形式主义。更多是在模仿人类，和学习人类的公序良俗。\n如今被抛弃公序良俗地搂在怀里的时候，却要穿着自己的外套，实在是不明白为什么——除了胸口骚动，刚也无法再想更多了。`,
  '1-07-00':`「刚切中元节24h」「夢廻の町 07:00」 拥抱、被拥抱`,
  '1-08-00':`「刚切中元节24h」「夢廻の町 08:00」\n\n“There is a crack in everything, that’s how the light gets in.”\n——Leonard Gohen, Anthem (1992)\n\n刚低头看着那只端着在桌子上，低头安静地舔爪子的猫。他不认识这只猫。\n大概是没主的猫，皮毛却油光水滑。\n从百叶窗的缝隙里穿进室内的光，在玻璃的桌面上画出一片一片的光斑，玻璃的器皿下晶莹剔透的反射，黑色的皮毛美丽地舒展着。\n猫安安静静的。就算刚的相机就在脚边也熟视无睹、泰然自若。\n刚不知道他要做什么。\n实际上，他甚至不知道自己为什么在这里。\n\n——这里又是哪里呢？`,
  '1-08-30':`「刚切中元节24h」「夢廻の町 08:30」\n\n“The light of memory, or rather the light that memory lends to things, is the palest light of all.”\n——Eugène Ionesco\n\nSignal Chaser轻轻鸣叫着跟在Chase的身边。\n和经常与换挡小车们说话的进之介与雾子、还有时不时和信号机车吵架的刚不同，Chase几乎不和那些帮助他战斗的车子们说话。\n实际上，他也不太进行交流这种行为。\n这也是可以理解的。说到底，他和这些小车们的关系也和他们不同，用他的一部分制作出的信号机车，说不定也是他意识的一部分。\nSignal Chaser突然叫了一声，扬起前轮。\nChase低头——是Signal Mach。\n——刚来过这里。\nChase并不十分理解。他不知道这里是哪里，也不知道自己为什么在这里。\n桌面上有一杯淡粉色的雪糕，看上去和曾经——哪里有曾经？\n他的程序是不是出了什么问题呢？Chase心想。\n雪糕看上去在哪里已经很久了，却没有水雾，也没有融化。吃起来的味道也莫名有些、难道曾经出现在他的程序里过吗？\n余光里，一只白色的猫不知从哪里来，跳到桌上。一边用脖子、腰和尾巴蹭他的手臂，一边喵喵地直叫。Chase没有对付猫的经验，于是只好置之不理。\n他抬头的时候，那只猫却已经开始拨动桌子上的玻璃球，似乎铁定心要给他捣乱。\nChase和猫对上视线——眼睛是蓝色的。`,
  '1-09-00':`「刚切中元节24h」「夢廻の町 09:00」\n\n“I am large, I contain multitudes.”\n「我无边无际，我包容万物。」\n\n——Walt Whitman, Song of Myself (1855)`,
  '1-10-00':`「刚切中元节24h」「夢廻の町 10:00」\n\n“Man is the only creature who refuses to be what he is.”\n「人是唯一拒绝做他自己之物的生物。」\n——Albert Camus\n\n倒在乱七八糟的仓库里的时候，诗岛刚顾不上被他的体重扯动，从更高处的箱子上滑落的红色幕布，还有被掀起的漫天的灰尘。他一双眼睛只顾着死死盯着面前的Roidmude。\n他不知道Chase为什么这种时候变回000的样子，他应该盯着Chase的胸口——“000”，真可怖，不过是铁皮的Roidmude！可是他只是瞧着那张金属的面孔，如此冰凉，以至于他的心口都揪起来。\n\n诗岛刚，你究竟想要什么？`,
  '1-11-00':`「刚切中元节24h」「夢廻の町 11:00」\n\n“They wore their armor as if it were a second skin, and yet beneath it, the heart still beat human.”\n「他们把盔甲穿得像第二层皮肤，然而在其下，心脏仍旧以人的节奏跳动。」\n\nChase仰头。\n如果他是人类，应该因为刺眼的阳光，蓝色护目镜式的复眼上闪动的光斑眯起眼睛；或者因为一直养着脑袋而感觉脖颈酸痛。\n可惜他不是，于是他努力地看着马赫。\n透明的面罩玻璃，亮蓝色的复眼，再下面就是刚的脸。Chase看不到也清楚。他心想，刚被马赫的装甲包裹，我看不到他的脸，但是刚在这里。他又想到他们曾经紧紧拥抱，不顾被汗水濡湿的床单在身下皱起的时候，刚的心脏——那颗作为人类的心脏，也在他看不到的胸腔里咚咚地跳动着。`,
  '1-12-00':`「刚切中元节24h」「夢廻の町 12:00」 《エルフ》\n\n「帰るべき家を探す　長い長い旅路を行くなら，\n追寻属于己的归宿　踏上无尽旅程，\n高らか鳴らせ　その心臓は最後の一打ちまで君の物だ，\n任心跳高声鸣响　直到停止跳动　那心脏仍属于你，\n涙涙　溢れるがいい　降る雫が君の森を育てるだろう，\n任晶莹泪珠坠落　这水滴将滋养属于你的森林，\n(愛しき)旅は続く，\n（亲爱的）旅程仍在继续，\n忘れたことも忘れてしまえ　哀しみも温もりも消えちまえ，\n将遗忘之事也一并忘却　让悲伤与温暖随风飘散，\nされど今も今も耳に残るは　固く再会を希うような，\n即便如此　此时此刻　那坚定希求重逢的”再会”。」\n\n——「エルフ」 Ado`,
  '1-13-00':`「刚切中元节24h」「夢廻の町 13:00」\n\n过去、现在、未来？\n恨与爱与爱。`,
  '1-14-00':`「刚切中元节24h」「夢廻の町 14:00」\n\n木樨草有一种泉水的甘冽，\n而爱散发出苹果的香味。\n但是我们闻一次也就永远知道了\n血，闻起来只能像血腥味……\n\n诗岛刚从梦中惊醒，血色在他的脑海中回荡着。他抑制不住地大口喘息，从仓库的地面上坐起。他的一只手还紧紧拽着那个装着平板的挎包，下意识地拉开拉链检查了平板的确还在。\n刚松了口气，心跳却没有半分减速。\n他翻开自己的笔记本，上面是不知什么时候摘录上去的诗文。\n刚忍不住舔了舔嘴唇，长时间地东躲西藏、居无定所，他的嘴唇有些开裂，于是他舔到细微的血腥味。于是更加饥饿，还有一种隐约的恐慌。`,
  '1-15-00':`「刚切中元节24h」「夢廻の町 15:00」\n\n混乱的、凌乱的\n黏腻的、紧密的`,
  '1-16-00':`「刚切中元节24h」「夢廻の町 16:00」\n\nRoidmude怕水吗？\n应当是不怕的。\n毕竟曾经那么多次淋雨，现在也好好的，穿着——大概是姐姐给她买的泳衣，手里拿着一个——大概是进哥给她的水枪，好像十分神气地站在那里。\n我看着她那样子好像曾经的死神举着破坏铳炮的严阵以待的样子。我也忍不住笑起来。\n我什么时候想着要跟这家伙来海滩玩的呢？\n已经有些记不清了。\n我的头发扎起来，但是也一定会弄湿，就像她的头发。\n但是这不是我现在考虑的事情。`,
  '1-17-00':`「刚切中元节24h」「夢廻の町 17:00」\n\n这之前的事情。\n如果可以的话，诗岛刚一辈子都不想回忆起这个场景。但是她毫无办法。\n她对梦境没有选择，时常在类似的梦中挣扎不得解脱。\nChase的脸永远那么清晰，发丝粘黏着血迹拧作一团，黏着她的脖颈，雪白的、已经失去类似人类的起伏的脖颈。她的眼睛像是宝石，蒙了尘一样缓缓地、缓缓地眨了两下。\n诗岛刚知道，接下来就是分离。\n哪怕是梦，她也应该说些什么。\n说点什么，什么都好，要说些什么……\n——他从梦里醒过来，头上的仪器箍得他有些头痛，也有可能是因为噩梦。\n修普诺斯担忧的声音响起。\n诗岛刚摆摆手，抹了一把额头上的冷汗。`,
  '1-18-00':`「刚切中元节24h」「夢廻の町 18:00」\n\n女人的身体是软的，哪怕自己也是女人，抱在怀里的感觉果然是……\n自己的头发已经汗湿了，她的头发只是更糟糕地黏在两个人的胸膛和背脊之间。`,
  '1-19-00':`「刚切中元节24h」「夢廻の町 19:00」\n\n自从Chase回到我身边之后，我拿起相机的频率就高了许多。\n不是说之前的时候，我就不爱摄影了。\n摄影是很早就成为我的一部分的东西，伊森刚死去的那段时间，我曾经迷茫到连摄影都不知道如何继续下去。哈雷博士和他的同伴们带给我新的目标。\nChase离开之后我却没有什么类似的感觉。\nChase的离开更像是——更像是新的目标出现在我的生命里。从打倒身为Roidmude的Chase，到复活他。\n只是，当你几乎没日没夜地宿在实验室里的时候，也就没什么机会拿起相机了。\n我的电脑里还有几张在实验室里实在手痒的时候、有些无聊的时候拍的照片。没什么好看的，或许有几张甚至没有对上焦——实在不像我会拍出来的东西。\n天气还微凉，正是樱花开的季节。\nChase走在我前面，他似乎对这样漫天飞粉的场景很是欢喜，脸上当然是没什么的表情的。但是我似乎就是知道，这让我也很满意。\n走到开得最盛的那棵樱花树下的时候，一阵风吹起，，地上的、树上未落的花瓣，纷纷扬扬地扑面而来。\n我下意识喊：\n“——Chase。”`,
  '1-20-00':`「刚切中元节24h」「夢廻の町 20:00」\n\nChase回来后，我们时常要回到美国。\n这是没有办法的事情。\n尽管拼尽全力把Chase的灵魂拼凑一起，又塞进了一具新的躯体，如今好好地走在天和地之间。不过难道灵魂也有水土不服、还是排异反应？他时常还是需要检查，日本的实验室器具不够齐全，我们就不得不回到美国。\n不过Chase对此似乎是什么意见都没有的。他认为这和人类的“定时体检”是一样的东西，似乎还有些高兴。\n至于总是要大费周章地飞到美国这件事，他也不甚在意。\n“刚去哪里我就去哪里。”\n“……说什么胡话！”\n我却不大喜欢这样的事情。\n当然，不做检查更是不可以的，我时常很担忧他的程序出问题，检查一下才能放心。\n只是我并不是很喜欢实验室的氛围，尤其是——看见Chase闭着眼睛躺在实验椅上，身上连着那么多线路。看着总是——`,
  '1-21-00':`「刚切中元节24h」「夢廻の町 21:00」\n\n刚的影子笼罩住我。\n刚的一部分在我的身体内。\n明明是这样简单的事情，我的程序却每次都因此几近崩溃。我很难理解自己的内部发生了什么。躯体的事情也好，程序的事情也好。传感器和运行全部都罢工的时候，我几乎什么都感觉不到、又什么都感觉到了。\n其实别的事情怎么样都好，只要能感觉到刚。看到刚的眼睛、和平时完全不一样的表情、听到刚似乎总也停不下来的喘息，还有刚紧紧抱住我的时候，和我的人造皮肤贴在一起、汗津津的皮肤，我就满足到无法停息对这件事的渴求。`,
  '1-22-00':`「刚切中元节24h」「夢廻の町 22:00」\n\n有时候，我会想这样的事情。\n所以现在这样也不奇怪。\n明明总是在脑子里反复地想、一遍遍假设。我没办法控制自己的身体的时候，第一件事情居然是毫不犹豫地扑了上去。\nChase被我扑倒在地上。\n我怀疑他的后脑勺可能会很痛——我在想什么呢？他可是个铁皮人。\n他看着我，表情居然有些茫然。\n我有些想骂他笨蛋，但是这不由我控制。\n直到看到一滴水落在Chase的脸颊上，我才后知后觉自己居然哭了。\n真是没出息。我在心里忍不住哼了一声。`,
  '1-23-00':`「刚切中元节24h」「夢廻の町 23:00」\n\n我知道这没有必要。\n但还是忍不住总是扭头去盯着Chase看。\n希望姐姐和进哥不要对此说什么，但是这也是没办法的事情。这是这个笨蛋Roidmude第一次吃烤肉。他好像很兴奋。我不知道自己有什么感想，可能有点紧张，大概有些期待。\n此刻是紧张。\n这个版本落后的机器人，真怕他出什么岔子。\n幸好只有我们四个，就算有什么问题——那也不会是什么问题。\n姐姐给我倒了一杯果汁。\n我抬头，下意识接过来：“姐姐，我早就不是小孩子了。”\n姐姐轻飘飘地笑了笑，一看就知道压根没把我的话放在心上。进哥也笑了起来——不知道这对夫妻什么意思。\n这两位刑警先生刚下班，听说我和Chase回到日本，说什么也要一起吃顿饭。\n英志去同学家玩了，所以没有一起来。\n我听了还有些惊奇。往常这小子最是对Chase感兴趣，以前的时候就经常缠着我问东问西。那个时候他还不知道，他心心念念的“舅舅的那个一直在旅行的朋友”，长了一张和“狩野叔叔”一模一样的可怕的木头脸。\n说到狩野——\n“欸，那不是狩野吗？”\n我这么一说，姐姐和进哥同时转头去看。\n只见狩野也一副刚下班的样子，西装外套抱在臂弯里，神色还是一如既往的严肃。\n他来这里干什么？不像他。\n进哥却冲他招手：“洸一，你怎么迟到了？不像你啊。”\n——啊，叫他干嘛？\n我撇了撇嘴，扭过头不再去看。烤盘上两块肉冒着恰到好处的香气。一块被姐姐夹走塞进了嘴里，另一块被我眼疾手快抢走。我转头看了看Chase，他正襟危坐，看上去和这里格格不入。我忍不住笑起来，举着筷子要他赶紧把肉吃了，多了一个刚下班的成年人来，等下可就更不好抢肉了。`,
  '1-24-00':`「刚切中元节24h」「夢廻の町 24:00」\n\n死亡是严寒的黑夜。\n生命是闷热的白天。\n天黑了，我进入梦乡，\n白天使我很疲惫。\n\n你那紫罗兰的明眸，\n日夜在我面前浮起，\n这可爱的碧色之迷，\n我弄不懂它的意义。`,
  '0-1':`——刚生气了吗？\n“刚，你生气了吗？”\n“……没有！”\n——刚为什么生气？\n\n——这个Roidmude是白痴吗？！`,
  '0-2-1':`刚很喜欢在我坐着的时候突然走过来。他会一言不发地坐到我身边，然后看看我——不是看我的脸部，他会瞄瞄我的肩膀和我的腿，微微皱着眉，然后挪一挪自己的位置。接着他松开眉头，会露出一个有些轻松的表情，然后“唰”地放松上半身，向我的方向倒过来。\n第一次刚这样做的时候，我非常紧张。虽然从刚的表情来看，他大概处于一种愉悦的情绪里，但是骤然倒身在我的数据库中，更类同于受伤时的反应。下一秒，刚的脑袋搁在了我的大腿上。\n我有些担心。因为紧张，我的腿部肌肉处于紧绷的状态，这样和刚的脑袋碰撞到一起，大概是很不舒服的。\n刚的表情却显得更加愉快了。\n\n这样的事情发生的次数多了之后，刚开始直接命令我：“Chase，你坐下。”我就明白他想要做什么。\n他也不太瞄着我调整位置，而是坐下后就倒到我的腿上。\n我低头就能看到他的脸。他总是笑着，看到他这样的笑容，我的核心总是微微的发烫，某种类似人类的多巴胺的数据流会充斥我的处理器。我有时候因此去摸刚的卷发，刚看上去会更高兴了。他喜欢叽叽喳喳地说话，内容无法预测，总是天南地北地东拉西扯。\n我不知道这种时候我的表情是什么样子的，但是刚看着我的眼神那样美丽，想来一定是个不错的表情。`,
  '0-2-2':`……这两个看上去很奇怪的消息是什么？\n其中一个怎么还拿着个……这是斧子吗？`,
  '0-3':`“Chase，这是你第一次看到‘海’吗？”刚端着他的相机，脸上的笑如何都止不住。\n眼前的人如何看都觉得欣喜，看上去、看上去正适合放在自己的相机光圈内。`,
  '0-4':`——是的，这是我第一次看到海。\nChase这样回复了刚。\n海风呼呼地刮着，吹乱了Chase的头发。他看到刚的相机对准了自己，于是忍不住伸手去捋自己的头发。`,
  '0-5':`距离第一次全球性冻结事件已经过去了十一年，距离第二次全球性冻结事件也已经过去了十年。\n时间居然能过去得这么快又这么慢。现在回忆起来，那一年大家本应如此心惊胆战地度过。可是，正是因为先后出现的那三位假面骑士，我们所有人才能安稳度日，从死亡的命运里逃脱，然后活到现在，庆祝和平的第十年。\n\n听说警视厅为了庆祝十年前的胜利——或者说得更恰当一些，纪念这个社会恢复平和的第十年，推出了不少活动。同事说，不过是有些缺钱了而已。我没有回应，但是心里其实相当赞同他的话。只是，我虽然赞同他的说法，却抱有和他不一样的态度。我很期待这些活动。尤其是关于那三位假面骑士的事情。\n十年前的时候——顺便一提，我那个时候还是高中生——红色的（我知道他还有别的颜色的样子，但是大众对他的印象统一都是红色）假面骑士是唯一暴露了身份的假面骑士。其真实身份是警视厅特状课的泊进之介巡警。我听说，在那不久之后，他就调到了一课，很快便升职成为了巡查部长。其余的两位假面骑士，因其身份为普通市民，并没有曝露身份。不过，银色的那位之后因为敌人的阴谋，身份也一时间被公之于众。只是十年过去，除了像我这样的人，恐怕早已对这段记忆很是模糊。毕竟，那之后，关于银色假面骑士的消息被有意地封锁和抹去了。\n我却是清楚的。我清楚地记得那个时候，生命被那些——我并不想称之为怪物的Roidmude威胁的时候，到底是谁救了我。我记得Chase先生那张有些僵硬的脸，还有刚先生总是显得很不高兴的脸。我从中毒的昏迷中醒来的时候，见到的就是这两位对我来说十分重要的英雄。\n\n这十年来，我和刚先生断断续续地维持着联系。早些年的时候，我能感觉到他的心情总是有些沉重，尽管他努力地用一种轻松欢快的语气写下文字、或者与我通话，但是我刚和他认识时，结果他总是扯着嘴角，对着Chase先生冷嘲热讽，也总是心事重重，但他似乎对一切总保持了希望。那几年却是不一样的，他似乎……不，那不是我应该去评价的事情了。\n后来有一段时间，我有些联系不上他了。进之介先生主动联系了我。他是个十分温柔的人，他告诉我，刚先生有十分重要的、不得不做的事情，如果运气好的话，很快就会带着好消息回来。他拜托我，和他还有刚先生的姐姐雾子小姐一起祈祷吧。\n又过去了几年，为了纪念假面骑士为这个社会的稳定作出的贡献，在进之介先生的同意下，警视厅出了不少三人的周边，其中就有他们的拍立得——当然，刚先生和Chase先生的只有假面骑士的照片，本人却是不出现的。\n但是昨天，我打开刚先生寄来的，久违的信件的时候，里面掉出来两张拍立得，我拿起来，惊喜地看到了刚先生的笑容，还有Chase先生，他和十年前一点区别都没有。`,
};

// ✅ 全局变量记录当前选中的 tag
let currentSelectedTag = null;

let typingInterrupted = false;  // 控制是否跳过打字动画

// ✅ 筛选作品 & 添加时间标签
window.onload = function () {
  const hash = window.location.hash;
  const selectedTag = hash.startsWith("#tag=") ? decodeURIComponent(hash.slice(5)) : null;
  currentSelectedTag = selectedTag;
  console.log("选中的 tag:", selectedTag);

  document.querySelectorAll('.work-item').forEach(item => {
    let tags = [];
    try {
      tags = JSON.parse(item.dataset.tags);
      console.log("此项的 tags:", tags);
    } catch (e) {
      console.error('data-tags 格式错误：', item.dataset.tags);
    }

    if (!selectedTag || tags.map(t => t.trim()).includes(selectedTag.trim())) {
      item.style.display = 'block';

      // ✅ 添加时间标签（仅对特定 tag）
      if (selectedTag === '「刚切中元节24h」「夢廻の町」') {
        const id = item.dataset.id || '';
        if (id.startsWith('1-') && !item.querySelector('.time-label')) {
          const parts = id.split('-');
          if (parts.length >= 3) {
            const hour = parts[1].padStart(2, '0');
            const min = parts[2].padStart(2, '0');
            const time = `${hour}:${min}`;
            const timeLabel = document.createElement('div');
            timeLabel.className = 'time-label';
            timeLabel.textContent = time;
            item.appendChild(timeLabel);
          }
        }
      }

    } else {
      item.style.display = 'none';
    }
  });
  
  checkVisibleItems();
};


// ✅ 弹窗逻辑
const popup = document.querySelector(".work-popup");
const popupImg = popup.querySelector(".popup-img");
const textIcon = document.getElementById('text-icon');
const textBox = document.getElementById('text-box');
const imageContainer = document.querySelector('.popup-image-container');

let currentGroup = [];
let currentIndex = 0;
let textVisible = false;
let currentTags = [];
let currentId = '';

// ✅ 作品点击事件

document.querySelectorAll('.work-item').forEach(item => {
  item.addEventListener('click', () => {
    currentGroup = JSON.parse(item.dataset.images);
    currentTags = JSON.parse(item.dataset.tags);
    currentId = item.dataset.id;
    currentIndex = 0;
    showImage();
    popup.style.display = 'flex';
    document.body.style.overflow = 'hidden';
    textVisible = false;
    textBox.classList.remove('active');
    textIcon.classList.remove('active');
  });
});

function showImage() {
  popupImg.onload = () => {
    const imgRatio = popupImg.naturalWidth / popupImg.naturalHeight;
    const maxW = window.innerWidth * 0.9;
    const maxH = window.innerHeight * 0.9;

    let w = maxW, h = maxW / imgRatio;
    if (h > maxH) {
      h = maxH;
      w = maxH * imgRatio;
    }
    imageContainer.style.width = w + 'px';
    imageContainer.style.height = h + 'px';
  }
  popupImg.src = currentGroup[currentIndex];
}

popupImg.addEventListener('mousemove', (e) => {
  const mid = popupImg.clientWidth / 2;
  popupImg.classList.toggle('left-hover', e.offsetX < mid);
  popupImg.classList.toggle('right-hover', e.offsetX >= mid);
});

popupImg.addEventListener('click', (e) => {
  const mid = popupImg.clientWidth / 2;
  currentIndex = (e.offsetX < mid)
    ? (currentIndex - 1 + currentGroup.length) % currentGroup.length
    : (currentIndex + 1) % currentGroup.length;
  showImage();
  textBox.classList.remove('active');
  textIcon.classList.remove('active');
  textVisible = false;
});

textIcon.addEventListener('click', () => {
  if (!textVisible) {
    const full = descriptions[currentId] || '';
    typeText(full);
    textBox.classList.add('active');
    textIcon.classList.add('active');
    imageContainer.classList.add('image-slide-left');
    textVisible = true;
  } else {
    textBox.classList.remove('active');
    textIcon.classList.remove('active');
    imageContainer.classList.remove('image-slide-left');
    textVisible = false;
  }
});

function typeText(text) {
  textBox.innerHTML = '';
  typingInterrupted = false;

  const lines = text.split('\n');

  const isTargetTag = currentSelectedTag === "「刚切中元节24h」「夢廻の町」";
  const hasTargetTag = currentTags.includes("「刚切中元节24h」「夢廻の町」");

  let title = '';

  // ✅ 情况 1：作品有特殊 tag 且当前显示的 tag 也为特殊 tag
  if (hasTargetTag && isTargetTag && lines.length && lines[0].startsWith('「刚切中元节24h」')) {
    title = lines.shift();

    const titleEl = document.createElement('div');
    titleEl.className = 'text-title';
    titleEl.textContent = title;
    textBox.appendChild(titleEl);

    const divider = document.createElement('div');
    divider.className = 'text-divider';
    textBox.appendChild(divider);
  }

  // ✅ 情况 2：作品有特殊 tag 但当前不是特殊 tag → 跳过第一行
  else if (hasTargetTag && !isTargetTag) {
    lines.shift(); // 不渲染标题
  }
  
  // ✅ 其他情况：不动第一行，直接渲染所有文字

  const textContainer = document.createElement('div');
  textBox.appendChild(textContainer);

  const cursor = document.createElement('span');
  cursor.className = 'typing-cursor';
  textContainer.appendChild(cursor);

  const fullText = lines.join('\n');
  let i = 0;

  function printChar() {
    if (typingInterrupted) {
      // ❗ 跳过动画，立即渲染所有行（保留空行）
      cursor.remove();
      textContainer.innerHTML = '';

      fullText.split('\n').forEach(line => {
        const lineEl = document.createElement('div');
        lineEl.textContent = line === '' ? '\u00A0' : line;  // 用不间断空格表示空行
        textContainer.appendChild(lineEl);
      });

      // 滚动到底部
      textBox.scrollTop = textBox.scrollHeight;
      return;
    }

    if (i < fullText.length) {
      const ch = fullText[i];
      const span = document.createElement('span');
      span.textContent = ch === '\n' ? '' : ch;
      textContainer.insertBefore(span, cursor);

      if (ch === '\n') {
        const br = document.createElement('br');
        textContainer.insertBefore(br, cursor);
      }

      i++;
      textBox.scrollTop = textBox.scrollHeight;
      setTimeout(printChar, 35);
    } else {
      cursor.remove();
    }
  }

  printChar();
}

function stripHeader(text) {
  const lines = text.split('\n');
  return lines.slice(1).filter(line => line.trim() !== '').join('\n');
}

popup.addEventListener('click', (e) => {
  if (!popupImg.contains(e.target) && !textIcon.contains(e.target) && !textBox.contains(e.target)) {
    popup.style.display = 'none';
    document.body.style.overflow = '';
    textBox.classList.remove('active');
    textIcon.classList.remove('active');
    imageContainer.classList.remove('image-slide-left');
    textVisible = false;
  }
});

// ✅ 鼠标样式控制
const customCursor = document.getElementById('custom-cursor');
popupImg.addEventListener('mousemove', (e) => {
  const rect = popupImg.getBoundingClientRect();
  const mid = rect.width / 2;
  const offsetX = e.clientX - rect.left;
  const isLeft = offsetX < mid;
  customCursor.classList.toggle('left', isLeft);
  customCursor.classList.toggle('right', !isLeft);
  customCursor.style.left = `${e.clientX}px`;
  customCursor.style.top = `${e.clientY}px`;
  customCursor.style.display = 'block';
});
popupImg.addEventListener('mouseleave', () => {
  customCursor.style.display = 'none';
});

// ✅ 滚动圆角控制
const container = document.querySelector('.works-container');
let isAtBottom = false;
container.addEventListener('scroll', () => {
  const { scrollTop, scrollHeight, clientHeight } = container;
  const nearBottom = scrollTop + clientHeight >= scrollHeight - 5;
  if (nearBottom && !isAtBottom) {
    container.classList.add('round-bottom');
    isAtBottom = true;
  } else if (!nearBottom && isAtBottom) {
    container.classList.remove('round-bottom');
    isAtBottom = false;
  }
});

function checkVisibleItems() {
  const container = document.querySelector('.works-container');
  const visibleItems = Array.from(document.querySelectorAll('.work-item')).filter(item => {
    return item.style.display !== 'none';
  });

  if (visibleItems.length < 6) {
    container.classList.add('round-bottom');
  } else {
    container.classList.remove('round-bottom');
  }
}

// ✅ 页面初始加载后显示左上角当前 tag 名称
document.addEventListener('DOMContentLoaded', () => {
  const hash = window.location.hash;
  const selectedTag = hash.startsWith("#tag=") ? decodeURIComponent(hash.slice(5)) : null;

  // 设置左上角标签名
  const tagLabel = document.getElementById('current-tag');
  if (tagLabel) {
    tagLabel.textContent = selectedTag ? `${selectedTag}` : '';
    tagLabel.style.display = selectedTag ? 'block' : 'none';
  }
  
  textBox.addEventListener('click', () => {
  if (textVisible) {
    typingInterrupted = true;
  }
});

});
